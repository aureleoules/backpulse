import React from 'react';

import {withRouter} from 'react-router';
import TextField from '@material-ui/core/TextField';
import Button from '@material-ui/core/Button';
import strings from 'strings';
import Grid from '@material-ui/core/Grid';

import Markdown from 'react-markdown/src/react-markdown';

import highlight from 'highlight.js';
import DialogContent from '@material-ui/core/DialogContent';

import './styles.scss';
import 'highlight.js/styles/atom-one-dark.css';
import Dialog from '@material-ui/core/Dialog';
import DialogTitle from '@material-ui/core/DialogTitle';
import DialogContentText from '@material-ui/core/DialogContentText';
import DialogActions from '@material-ui/core/DialogActions';
import client from 'services/client';
import CircularProgress from '@material-ui/core/CircularProgress';
import { withSnackbar } from 'notistack';

class EditArticle extends React.Component {
    
    constructor(props) {
        super(props);
        this.state = {
            errorField: "",
            error: false,
            fetched: false,
            confirmDelete: false,
            // Article data
            title: "",
            content: "## My new article",
            // meta
            id: "",
            short_id: ""
        }
    }

    fetchArticle = () => {
        const id = this.props.match.params.id;
        this.setState({fetched: false});
        client.get('/articles/' + this.props.match.params.name + '/' + id).then(response => {
            console.log(response.data);
            const article = response.data.payload;
            this.setState({...article, fetched: true}, () => this.showColors());
        }).catch(err => {
            if(err) throw err;
        });
    }

    componentDidMount() {
        if(!this.props.new) {
            this.fetchArticle();
        }
    }

    onType = e => {
        this.setState({content: e.target.value});
    }

    

    showColors = () => {
        const elements = document.getElementsByTagName("code");
        for(let i = 0; i < elements.length; i++) {
            const element = elements[i];
            highlight.highlightBlock(element);
        }
        setTimeout(() => {
            this.showColors();
        }, 2000);
    }

    handleSave = e => {
        e.preventDefault();
        console.log("isUpdate?", !this.props.new);
        console.log(this.props.match.params);
        const article = {
            title: this.state.title,
            content: this.state.content,
            short_id: this.state.short_id,
            id: this.state.id
        }
        client.put('/articles/'+this.props.match.params.name, article).then(response => {
            console.log(response.data);
            this.props.history.push('/site/' + this.props.match.params.name + '/articles/edit/' + response.data.payload.short_id);
            this.props.enqueueSnackbar(strings.ARTICLE_SAVED, {variant: "success"})
        }).catch(err => {
            if(err) throw err;
        });
    }

    closeConfirmDelete = () => this.setState({
        confirmDelete: false
    });

    confirmDelete = () => this.setState({
        confirmDelete: true
    });

    deleteArticle = () => {
        client.delete('/articles/' + this.props.match.params.name + '/' + this.state.short_id).then(response => {
            this.closeConfirmDelete();
            this.props.history.push('/site/' + this.props.match.params.name + '/articles');
        }).catch(err => {
            if(err) throw err;
        });
    }

    render() {
        return (
            <div className="page dashboard-edit-article">
                <h1>{this.props.new ? strings.NEW_ARTICLE : strings.EDIT_ARTICLE}</h1>
                {!this.state.fetched && !this.props.new && <CircularProgress/>}
                {(this.props.new || this.state.fetched) && (
                    <form onSubmit={this.handleSave}>
                        <TextField
                            error={this.state.errorField === "title"}
                            label={strings.TITLE}
                            value={this.state.title}
                            multiline
                            onChange={e => this.setState({title: e.target.value})}
                            margin="normal"
                            variant={"outlined"}
                            fullWidth
                            required
                        />
                        <Grid spacing={16} container>
                            <Grid item md={6} xs={12}>
                                <TextField
                                    required
                                    error={this.state.errorField === "content"}
                                    label={strings.CONTENT}
                                    value={this.state.content}
                                    variant={"outlined"}
                                    multiline
                                    onChange={this.onType}
                                    margin="normal"
                                    rows={25}
                                    rowsMax={100}
                                    onKeyDown={e => {
                                        console.log(e.keyCode)
                                        if(e.keyCode === 9) {
                                            e.preventDefault();
                                            this.setState({content: this.state.content + "    "})
                                        }
                                    }}
                                    fullWidth
                                />
                            </Grid>
                            <Grid item md={6} xs={12}>
                                <Markdown className="markdown-preview" source={this.state.content}/>    
                            </Grid>
                        </Grid>
                        <Grid item xs={12} md={3}>
                            <Button fullWidth color="primary" variant="contained" style={{marginTop: 15}} type="submit">
                                {strings.SAVE}
                            </Button>
                        </Grid>
                        <Grid item xs={12} md={3}> 
                            <Button fullWidth className="button-danger" variant="contained" style={{marginTop: 15}} onClick={this.confirmDelete}>
                                {strings.DELETE}
                            </Button>
                        </Grid>
                    </form>
                )}

                <Dialog
                    open={this.state.confirmDelete}
                    onClose={this.closeConfirmDelete}
                    >
                    <DialogTitle>{strings.DELETE_ARTICLE}</DialogTitle>
                    <DialogContent>
                        <DialogContentText>
                            {strings.CONFIRM_DELETE_ARTICLE_DESCRIPTION}             
                        </DialogContentText>
                    </DialogContent>
                    <DialogActions>
                        <Button onClick={this.closeConfirmDelete} color="primary" autoFocus>
                            {strings.CANCEL}
                        </Button>
                        <Button onClick={this.deleteArticle} className="button-danger">
                            {strings.DELETE}
                        </Button>
                    </DialogActions>
                </Dialog>
            </div>
        )
    }
}

export default withRouter(withSnackbar(EditArticle));